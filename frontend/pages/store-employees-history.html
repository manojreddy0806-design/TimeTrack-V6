<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Employee History ‚Äî Pramaan</title>
    <link rel="stylesheet" href="static/css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* Mobile Menu Styles */
        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .mobile-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .mobile-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 280px;
            max-width: 85vw;
            height: 100vh;
            background: linear-gradient(to bottom, #2c3e50, #1b2b36);
            z-index: 50;
            transition: right 0.3s ease;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }
        .mobile-menu.active {
            right: 0;
        }
        .mobile-menu-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .mobile-menu-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .mobile-menu-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .mobile-menu-nav {
            padding: 1rem 0;
        }
        .mobile-menu-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .mobile-menu-link:hover,
        .mobile-menu-link.active {
            background: rgba(255, 255, 255, 0.15);
            border-left-color: white;
            color: white;
        }
        .mobile-menu-link i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }
        .mobile-menu-btn {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
        }
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            .mobile-menu-btn {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="nav-left">
            <div class="logo">‚è∞ Pramaan</div>
            <nav class="nav-links">
                <a href="manager.html">Dashboard</a>
                <a href="add-employee.html">Add Employee</a>
                <a href="billings-payments.html">Billings & Payments</a>
                <a href="list-employees.html">Employees</a>
            </nav>
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
        <div class="nav-right">
            <a href="#" class="btn-logout" onclick="logoutApp()">Logout</a>
        </div>
    </div>
    
    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="closeMobileMenu()"></div>
    
    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <span style="color: white; font-weight: bold; font-size: 1.125rem;">Menu</span>
            <button class="mobile-menu-close" onclick="closeMobileMenu()">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <nav class="mobile-menu-nav">
            <a href="manager.html" class="mobile-menu-link" onclick="closeMobileMenu()">
                <i class="fa-solid fa-chart-pie"></i>
                Dashboard
            </a>
            <a href="add-employee.html" class="mobile-menu-link" onclick="closeMobileMenu()">
                <i class="fa-solid fa-user-plus"></i>
                Add Employee
            </a>
            <a href="billings-payments.html" class="mobile-menu-link" onclick="closeMobileMenu()">
                <i class="fa-solid fa-credit-card"></i>
                Billings & Payments
            </a>
            <a href="list-employees.html" class="mobile-menu-link" onclick="closeMobileMenu()">
                <i class="fa-solid fa-users"></i>
                Employees
            </a>
            <div style="border-top: 1px solid rgba(255, 255, 255, 0.2); margin: 0.5rem 0;"></div>
            <button class="mobile-menu-link w-full text-left" onclick="logoutApp(); closeMobileMenu();" style="border: none; background: none; cursor: pointer;">
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
                Logout
            </button>
        </nav>
    </div>
    <div class="container">
        <h2 id="storeTitle">Employee Attendance History</h2>
        <div style="margin-top:12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <button id="backBtn" class="bulk-update-btn" style="background:#6c757d">‚Üê Back to Today</button>
            <select id="daysFilter" style="padding:8px 16px;border-radius:8px;border:1px solid #dee2e6;font-size:1rem;">
              <option value="7">Last 7 Days</option>
              <option value="30" selected>Last 30 Days</option>
              <option value="60">Last 60 Days</option>
              <option value="90">Last 90 Days</option>
            </select>
            <button id="refreshBtn" class="bulk-update-btn" style="background:#28a745">üîÑ Refresh</button>
        </div>
        <div id="employeesHistoryList" style="margin-top:20px"></div>
    </div>
    <script src="static/js/script.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const storeName = urlParams.get('store') || 'Store';
        
        const storeTitle = document.getElementById('storeTitle');
        const backBtn = document.getElementById('backBtn');
        const daysFilter = document.getElementById('daysFilter');
        const refreshBtn = document.getElementById('refreshBtn');
        const employeesHistoryList = document.getElementById('employeesHistoryList');
        
        if (storeTitle) {
          storeTitle.textContent = `${storeName} ‚Äî Attendance History`;
        }
        
        if (backBtn) {
          backBtn.addEventListener('click', () => {
            window.location = `store-employees-today.html?store=${encodeURIComponent(storeName)}`;
          });
        }
        
        async function loadEmployeesHistory() {
          try {
            if (!employeesHistoryList) return;
            
            const days = daysFilter ? parseInt(daysFilter.value) : 30;
            
            employeesHistoryList.innerHTML = '<div style="text-align:center;padding:40px;color:#6c757d;">Loading...</div>';
            
            // Use apiGet to include authentication headers
            const data = await apiGet(`/timeclock/history`, { store_id: storeName, days: days });
            
            if (!data.entries || data.entries.length === 0) {
              employeesHistoryList.innerHTML = '<div class="no-data" style="text-align:center;padding:40px;color:#6c757d;">No attendance records found.</div>';
              return;
            }
            
            let html = `<div style="margin-bottom:20px;padding:16px;background:#f8f9fa;border-radius:8px;">
              <h3 style="margin:0;color:#2c3e50;">üìä Attendance Records</h3>
              <p style="margin:8px 0 0 0;color:#6c757d;">Total Entries: ${data.total_count} (Last ${days} days)</p>
            </div>`;
            
            html += '<div style="display:grid;gap:12px;">';
            
            // Group by date
            const groupedByDate = {};
            data.entries.forEach(entry => {
              const date = new Date(entry.clock_in).toLocaleDateString('en-US');
              if (!groupedByDate[date]) {
                groupedByDate[date] = [];
              }
              groupedByDate[date].push(entry);
            });
            
            // Sort dates descending
            const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));
            
            sortedDates.forEach(date => {
              const entries = groupedByDate[date];
              const dateObj = new Date(date);
              const dateStr = dateObj.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
              });
              
              html += `
                <div style="background:white;padding:20px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                  <h3 style="margin:0 0 16px 0;color:#2c3e50;font-size:1.2rem;border-bottom:2px solid #e9ecef;padding-bottom:8px;">
                    üìÖ ${dateStr}
                  </h3>
                  <div style="display:grid;gap:12px;">
              `;
              
              entries.forEach(emp => {
                const clockInTime = new Date(emp.clock_in);
                const clockInStr = clockInTime.toLocaleTimeString('en-US', {
                  hour: '2-digit',
                  minute: '2-digit',
                  hour12: true
                });
                
                let clockOutStr = 'Not Clocked Out';
                let hoursStr = '';
                let statusColor = '#ffc107';
                
                if (emp.clock_out) {
                  const clockOutTime = new Date(emp.clock_out);
                  clockOutStr = clockOutTime.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                  });
                  hoursStr = emp.hours_worked ? `${emp.hours_worked} hrs` : '';
                  statusColor = '#28a745';
                }
                
                html += `
                  <div style="padding:12px;background:#f8f9fa;border-radius:8px;border-left:3px solid ${statusColor};">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                      <div style="flex:1;">
                        <div style="font-weight:600;color:#2c3e50;margin-bottom:4px;">
                          <a href="employee-activities.html${emp.employee_id ? '?employeeId=' + emp.employee_id : ''}" style="color:#007bff;text-decoration:none;cursor:pointer;" 
                             onmouseover="this.style.textDecoration='underline'" 
                             onmouseout="this.style.textDecoration='none'">
                            ${emp.employee_name || 'Unknown'}
                          </a>
                        </div>
                        <div style="font-size:0.9rem;color:#6c757d;">
                          In: ${clockInStr} | Out: ${clockOutStr}
                        </div>
                      </div>
                      ${hoursStr ? `<div style="font-weight:700;color:#007bff;font-size:1.1rem;">${hoursStr}</div>` : ''}
                    </div>
                  </div>
                `;
              });
              
              html += `
                  </div>
                </div>
              `;
            });
            
            html += '</div>';
            
            employeesHistoryList.innerHTML = html;
            
          } catch (error) {
            console.error('Error loading employees history:', error);
            if (employeesHistoryList) {
              employeesHistoryList.innerHTML = '<div class="no-data" style="text-align:center;padding:40px;color:#dc3545;">Failed to load history. Please try again.</div>';
            }
          }
        }
        
        if (daysFilter) {
          daysFilter.addEventListener('change', loadEmployeesHistory);
        }
        
        if (refreshBtn) {
          refreshBtn.addEventListener('click', loadEmployeesHistory);
        }
        
        // Load data
        loadEmployeesHistory();
      });
      
      // Mobile Menu Functions
      function toggleMobileMenu() {
          const overlay = document.getElementById('mobileMenuOverlay');
          const menu = document.getElementById('mobileMenu');
          overlay.classList.toggle('active');
          menu.classList.toggle('active');
          if (menu.classList.contains('active')) {
              document.body.style.overflow = 'hidden';
          } else {
              document.body.style.overflow = '';
          }
      }
      
      function closeMobileMenu() {
          const overlay = document.getElementById('mobileMenuOverlay');
          const menu = document.getElementById('mobileMenu');
          overlay.classList.remove('active');
          menu.classList.remove('active');
          document.body.style.overflow = '';
      }
      
      document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
              closeMobileMenu();
          }
      });
      
      function updateMobileMenuActiveState() {
          const currentPath = window.location.pathname.split('/').pop() || window.location.href.split('/').pop();
          const mobileLinks = document.querySelectorAll('.mobile-menu-link');
          mobileLinks.forEach(link => {
              link.classList.remove('active');
              const href = link.getAttribute('href');
              if (href && href !== '#') {
                  const hrefPath = href.split('/').pop().split('#')[0];
                  if (hrefPath === currentPath) {
                      link.classList.add('active');
                  }
              }
          });
      }
      
      updateMobileMenuActiveState();
    </script>
</body>
</html>
