<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Inventory History — Pramaan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="static/css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            DEFAULT: '#3B82F6',
                            hover: '#2563EB'
                        },
                        secondary: '#64748B',
                        light: '#F8FAFC',
                        'card-border': '#E2E8F0',
                        'input-border': '#CBD5E1'
                    }
                }
            }
        };
    </script>
    <style>
        .inventory-grid-container {
            overflow-x: auto;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        .inventory-grid-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        .inventory-grid-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: center;
            font-weight: 700;
            color: #2c3e50;
            border: 1px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .inventory-grid-table th.item-header {
            text-align: left;
            position: sticky;
            left: 0;
            background: #f8f9fa;
            z-index: 11;
        }
        .inventory-grid-table td {
            padding: 10px 12px;
            text-align: center;
            border: 1px solid #e9ecef;
            color: #495057;
        }
        .inventory-grid-table td.item-cell {
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            left: 0;
            background: white;
            z-index: 9;
        }
        .inventory-grid-table tbody tr:hover {
            background: #f8f9fa;
        }
        .inventory-grid-table tbody tr.special-row {
            background: #fff3cd;
            font-weight: 700;
        }
        .inventory-grid-table tbody tr.special-row td.item-cell {
            background: #fff3cd;
        }
        .empty-cell {
            color: #adb5bd;
        }
        .device-type-section {
            margin-bottom: 2rem;
        }
        .device-type-header {
            background: #f8f9fa;
            padding: 12px 16px;
            font-weight: 700;
            font-size: 1.1rem;
            color: #2c3e50;
            border: 1px solid #dee2e6;
            border-bottom: none;
        }
        .device-type-header.discontinued {
            background: #fff3cd;
        }
    </style>
    <style>
        ::-webkit-scrollbar { display: none; }
        @keyframes fadeInPage {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .page-fade-in {
            animation: fadeInPage 0.6s ease forwards;
        }
        /* Mobile Menu Styles */
        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .mobile-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .mobile-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 280px;
            max-width: 85vw;
            height: 100vh;
            background: linear-gradient(to bottom, #2563eb, #1d4ed8);
            z-index: 50;
            transition: right 0.3s ease;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }
        .mobile-menu.active {
            right: 0;
        }
        .mobile-menu-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .mobile-menu-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .mobile-menu-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .mobile-menu-nav {
            padding: 1rem 0;
        }
        .mobile-menu-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .mobile-menu-link:hover,
        .mobile-menu-link.active {
            background: rgba(255, 255, 255, 0.15);
            border-left-color: white;
            color: white;
        }
        .mobile-menu-link i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-light font-sans antialiased text-slate-800">
    <div id="app-container" class="min-h-screen pb-12">
        <header id="header" class="sticky top-0 z-50 w-full">
            <div class="w-[95%] max-w-7xl mx-auto mt-4 bg-gradient-to-r from-blue-600 to-blue-700 backdrop-blur-xl rounded-2xl shadow-2xl border border-blue-400/30">
                <div class="flex items-center justify-between px-10 py-4">
                    <div class="flex items-center space-x-3">
                        <div class="bg-white rounded-xl p-2.5 flex items-center justify-center hover:scale-110 transition-transform duration-200 shadow-lg">
                            <i class="fa-solid fa-clock text-blue-600 text-xl"></i>
                        </div>
                        <span class="text-2xl font-bold text-white">Pramaan</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <nav id="managerNavLinks" class="hidden md:flex items-center space-x-3 bg-blue-700/20 px-3 py-2 rounded-xl backdrop-blur-sm">
                            <a href="manager.html" id="dashboardLink" data-nav-link class="relative z-10 flex items-center px-6 py-2.5 text-sm font-semibold text-blue-50 hover:text-white hover:bg-blue-400/50 rounded-lg transition-all duration-300 hover:scale-105 hover:shadow-lg transform">
                                <i class="fa-solid fa-chart-pie mr-2"></i>
                                Dashboard
                            </a>
                            <a href="add-employee.html" id="addEmployeeLink" data-nav-link class="relative z-10 flex items-center px-6 py-2.5 text-sm font-semibold text-blue-50 hover:text-white hover:bg-blue-400/50 rounded-lg transition-all duration-300 hover:scale-105 hover:shadow-lg transform">
                                <i class="fa-solid fa-user-plus mr-2"></i>
                                Add Employee
                            </a>
                            <a href="billings-payments.html" id="billingsLink" data-nav-link class="relative z-10 flex items-center px-6 py-2.5 text-sm font-semibold text-blue-50 hover:text-white hover:bg-blue-400/50 rounded-lg transition-all duration-300 hover:scale-105 hover:shadow-lg transform">
                                <i class="fa-solid fa-credit-card mr-2"></i>
                                Billings & Payments
                            </a>
                            <a href="list-employees.html" id="listEmployeesLink" data-nav-link class="relative z-10 flex items-center px-6 py-2.5 text-sm font-semibold text-blue-50 hover:text-white hover:bg-blue-400/50 rounded-lg transition-all duration-300 hover:scale-105 hover:shadow-lg transform">
                                <i class="fa-solid fa-users mr-2"></i>
                                Employees
                            </a>
                        </nav>
                        <a href="#" id="backToSuperAdmin" class="hidden items-center px-4 py-2 text-sm font-semibold text-blue-50 hover:text-white hover:bg-blue-400/50 rounded-lg transition-all duration-300 mr-4">
                            <i class="fa-solid fa-arrow-left mr-2"></i>
                            Back
                        </a>
                        <button class="hidden md:flex items-center px-6 py-2.5 text-sm font-semibold text-blue-50 hover:text-white hover:bg-blue-400/50 rounded-lg transition-all duration-300 hover:scale-105 hover:shadow-lg transform border border-white/20" onclick="logoutApp()">
                            <i class="fa-solid fa-arrow-right-from-bracket mr-2"></i>
                            Logout
                        </button>
                        <button class="md:hidden text-white hover:text-blue-200 transition-colors duration-200" onclick="toggleMobileMenu()" id="mobileMenuBtn">
                            <i class="fa-solid fa-bars text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Mobile Menu Overlay -->
        <div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="closeMobileMenu()"></div>
        
        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <div class="mobile-menu-header">
                <span class="text-white font-bold text-lg">Menu</span>
                <button class="mobile-menu-close" onclick="closeMobileMenu()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <nav class="mobile-menu-nav">
                <a href="manager.html" class="mobile-menu-link" onclick="closeMobileMenu()">
                    <i class="fa-solid fa-chart-pie"></i>
                    Dashboard
                </a>
                <a href="add-employee.html" class="mobile-menu-link" onclick="closeMobileMenu()">
                    <i class="fa-solid fa-user-plus"></i>
                    Add Employee
                </a>
                <a href="billings-payments.html" class="mobile-menu-link" onclick="closeMobileMenu()">
                    <i class="fa-solid fa-credit-card"></i>
                    Billings & Payments
                </a>
                <a href="list-employees.html" class="mobile-menu-link" onclick="closeMobileMenu()">
                    <i class="fa-solid fa-users"></i>
                    Employees
                </a>
                <a href="#" id="backToSuperAdminMobile" class="mobile-menu-link" onclick="closeMobileMenu()">
                    <i class="fa-solid fa-arrow-left"></i>
                    Back
                </a>
                <div class="border-t border-white/20 my-2"></div>
                <button class="mobile-menu-link w-full text-left" onclick="logoutApp(); closeMobileMenu();" style="border: none; background: none; cursor: pointer;">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i>
                    Logout
                </button>
            </nav>
        </div>

        <main id="main-content" class="page-fade-in max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-12">
            <div id="inventory-history-section" class="bg-white rounded-2xl shadow-lg border border-card-border overflow-hidden">
                <div id="inventory-history-header" class="px-8 py-5 border-b border-card-border flex justify-between items-center bg-slate-50/50">
                    <div>
                        <h2 id="storeTitle" class="text-2xl font-bold text-slate-800">Inventory History</h2>
                        <p class="text-sm text-slate-500">Daily Inventory Snapshot by Device Type</p>
                    </div>
                    <div class="text-right">
                        <h3 class="text-lg font-semibold text-primary mb-2">Inventory History</h3>
                        <div class="flex items-center justify-end gap-3">
                            <button id="prevPeriodBtn" class="p-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-50 hover:border-primary transition-all duration-200 hover:scale-105" title="Previous 11 Days">
                                <i class="fa-solid fa-chevron-left text-slate-700"></i>
                            </button>
                            <span id="periodRange" class="text-sm text-slate-600 font-medium min-w-[250px] text-center">Loading...</span>
                            <button id="nextPeriodBtn" class="p-2 rounded-lg bg-white border border-slate-300 hover:bg-slate-50 hover:border-primary transition-all duration-200 hover:scale-105" title="Next 11 Days">
                                <i class="fa-solid fa-chevron-right text-slate-700"></i>
                            </button>
                            <button id="downloadExcelBtn" class="ml-3 flex items-center gap-2 px-5 py-2.5 text-sm font-semibold text-white bg-emerald-600 rounded-lg hover:bg-emerald-700 hover:shadow-lg hover:scale-105 transition-all duration-200 shadow-sm">
                                <i class="fa-solid fa-download"></i>
                                Download Excel
                            </button>
                        </div>
                    </div>
                </div>
                <div id="inventory-table-container" class="p-6">
                    <div id="loadingState" class="hidden text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mb-4"></div>
                        <p class="text-slate-600">Loading inventory history...</p>
                    </div>
                    <div id="errorState" class="hidden text-center py-12">
                        <i class="fa-solid fa-triangle-exclamation text-red-500 text-4xl mb-4"></i>
                        <p class="text-red-600 font-semibold" id="errorMessage">Failed to load inventory history</p>
                    </div>
                    <div id="tableContent" class="text-center py-12 text-slate-600">
                        No inventory history found.
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="static/js/script.js"></script>
    <script>
        // Check session
        const session = loadSession();
        if (!session || (session.role !== 'manager' && session.role !== 'super-admin' && session.role !== 'admin')) {
            showError('Access denied. Manager, Admin, or Super Admin login required.');
            window.location = 'login.html';
        }
        
        // Get store name and view_as from URL
        const urlParams = new URLSearchParams(window.location.search);
        const storeName = urlParams.get('store') || 'Store';
        const viewAs = urlParams.get('view_as');
        
        // Show "Back" button and hide manager nav links if user is super-admin or admin AND view_as is present
        const managerNavLinks = document.getElementById('managerNavLinks');
        const backToSuperAdmin = document.getElementById('backToSuperAdmin');
        if (viewAs && (session?.role === 'super-admin' || session?.role === 'admin')) {
            // Hide manager navigation links
            if (managerNavLinks) {
                managerNavLinks.style.display = 'none';
            }
            // Show back button
            if (backToSuperAdmin) {
                if (session?.role === 'admin') {
                    backToSuperAdmin.href = "admin.html";
                    backToSuperAdmin.innerHTML = '<i class="fa-solid fa-arrow-left mr-2"></i> Back to Admin';
                } else {
                    backToSuperAdmin.href = "super-admin.html";
                    backToSuperAdmin.innerHTML = '<i class="fa-solid fa-arrow-left mr-2"></i> Back to Super Admin';
                }
                backToSuperAdmin.classList.remove("hidden");
                backToSuperAdmin.classList.add("md:flex");
            }
        } else {
            // Show manager nav links and hide back button for regular managers
            if (managerNavLinks) {
                managerNavLinks.style.display = '';
            }
            if (backToSuperAdmin) {
                backToSuperAdmin.classList.add("hidden");
                backToSuperAdmin.classList.remove("md:flex");
            }
        }
        
        // Update title
        document.getElementById('storeTitle').textContent = `Inventory History — ${storeName}`;
        
        let allSnapshots = [];
        let currentPeriodStart = null;
        let gridData = null;
        const DAYS_PER_PERIOD = 11;
        
        // Initialize period to last 11 days (ending today)
        function initPeriod() {
            const today = new Date();
            today.setHours(23, 59, 59, 999); // End of today
            currentPeriodStart = new Date(today);
            currentPeriodStart.setDate(today.getDate() - (DAYS_PER_PERIOD - 1)); // 11 days including today
            currentPeriodStart.setHours(0, 0, 0, 0);
        }
        
        // Update period to match latest snapshots after loading
        function adjustPeriodToSnapshots() {
            if (allSnapshots.length === 0) return;
            
            // Always use today as the period end to ensure today's snapshot is included if it exists
            const today = new Date();
            today.setHours(23, 59, 59, 999); // End of today
            
            // Set period to end on today (this ensures today's snapshot will be included)
            currentPeriodStart = new Date(today);
            currentPeriodStart.setDate(today.getDate() - (DAYS_PER_PERIOD - 1));
            currentPeriodStart.setHours(0, 0, 0, 0);
            
            console.log('Period adjusted to include today - Start:', formatDate(currentPeriodStart), 'End:', formatDate(today));
            updatePeriodRange();
        }
        
        function getPeriodEnd() {
            // Always ensure period ends at least at today
            const today = new Date();
            today.setHours(23, 59, 59, 999); // End of today
            
            const calculatedEnd = new Date(currentPeriodStart);
            calculatedEnd.setDate(currentPeriodStart.getDate() + (DAYS_PER_PERIOD - 1));
            
            // Return the later of: calculated end or today (always include today)
            return calculatedEnd > today ? calculatedEnd : today;
        }
        
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }
        
        function formatDisplayDate(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = d.toLocaleDateString('en-US', { month: 'short' });
            return `${day}-${month}`;
        }
        
        function updatePeriodRange() {
            // Ensure period is initialized
            if (!currentPeriodStart) {
                initPeriod();
            }
            
            const periodEnd = getPeriodEnd();
            const startStr = formatDisplayDate(currentPeriodStart);
            const endStr = formatDisplayDate(periodEnd);
            const periodRangeEl = document.getElementById('periodRange');
            if (periodRangeEl) {
                periodRangeEl.textContent = `${startStr} to ${endStr}`;
            }
        }
        
        // Normalize date to YYYY-MM-DD format
        function normalizeDate(dateStr) {
            if (!dateStr) return '';
            // Handle ISO format dates (e.g., "2024-12-03T00:00:00" or "2024-12-03T00:00:00Z")
            const match = String(dateStr).match(/^(\d{4}-\d{2}-\d{2})/);
            if (match) {
                return match[1];
            }
            // If it's a Date object, convert to YYYY-MM-DD
            if (dateStr instanceof Date) {
                return formatDate(dateStr);
            }
            return dateStr;
        }
        
        // Get snapshots for current period
        function getCurrentPeriodSnapshots() {
            const startDate = formatDate(currentPeriodStart);
            const endDate = formatDate(getPeriodEnd());
            
            console.log('Filtering snapshots for period:', startDate, 'to', endDate);
            console.log('Total snapshots available:', allSnapshots.length);
            
            // Filter snapshots within the period
            const periodSnapshots = allSnapshots.filter(snapshot => {
                const snapshotDate = normalizeDate(snapshot.snapshot_date);
                const inRange = snapshotDate >= startDate && snapshotDate <= endDate;
                if (inRange) {
                    console.log('Snapshot found in range:', snapshotDate, snapshot.snapshot_date);
                }
                return inRange;
            });
            
            // If no snapshots in current period, try to get the latest 11 snapshots
            if (periodSnapshots.length === 0 && allSnapshots.length > 0) {
                console.log('No snapshots in current period, using latest 11 snapshots');
                // Get the latest 11 snapshots (they're already sorted newest first)
                const latestSnapshots = allSnapshots.slice(0, 11);
                // Reverse to show oldest first
                latestSnapshots.reverse();
                
                // Update the period to match the actual snapshot dates
                if (latestSnapshots.length > 0) {
                    const firstDate = new Date(latestSnapshots[0].snapshot_date);
                    const lastDate = new Date(latestSnapshots[latestSnapshots.length - 1].snapshot_date);
                    currentPeriodStart = new Date(firstDate);
                    currentPeriodStart.setHours(0, 0, 0, 0);
                    updatePeriodRange();
                }
                
                return latestSnapshots;
            }
            
            // Sort by date (oldest first for chronological display)
            periodSnapshots.sort((a, b) => {
                const dateA = new Date(a.snapshot_date);
                const dateB = new Date(b.snapshot_date);
                return dateA - dateB;
            });
            
            console.log('Returning', periodSnapshots.length, 'snapshots for period');
            return periodSnapshots;
        }
        
        async function loadInventoryHistory() {
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const tableContent = document.getElementById('tableContent');
            const errorMessage = document.getElementById('errorMessage');
            
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            tableContent.classList.add('hidden');
            
            try {
                const session = loadSession();
                const storeIdToUse = storeName || session?.storeId || 'Store';
                
                allSnapshots = await apiGet('/inventory/history', { store_id: storeIdToUse });
                
                // Initialize period if not already set
                if (!currentPeriodStart) {
                    initPeriod();
                }
                
                // Update period range even if there's no history
                updatePeriodRange();
                
                if (allSnapshots.length === 0) {
                    loadingState.classList.add('hidden');
                    tableContent.innerHTML = '<div class="text-center py-12 text-slate-600">No inventory history found for this store.</div>';
                    tableContent.classList.remove('hidden');
                    return;
                }
                
                // Sort by date (newest first)
                allSnapshots.sort((a, b) => {
                    const dateA = new Date(a.snapshot_date);
                    const dateB = new Date(b.snapshot_date);
                    return dateB - dateA;
                });
                
                // Adjust period to always include today if snapshots exist
                // This ensures today's snapshot is always shown when it exists
                const todayStr = formatDate(new Date());
                
                if (allSnapshots.length > 0) {
                    const latestSnapshot = allSnapshots[0];
                    const latestDate = new Date(latestSnapshot.snapshot_date);
                    const latestDateStr = formatDate(latestDate);
                    const currentEndStr = formatDate(getPeriodEnd());
                    
                    // Check if latest snapshot is for today
                    const isTodaySnapshot = latestDateStr === todayStr;
                    
                    // Check if ANY snapshot exists for today
                    const hasTodaySnapshot = allSnapshots.some(s => formatDate(new Date(s.snapshot_date)) === todayStr);
                    
                    // Debug: Print all snapshot dates to verify today's snapshot is in the list
                    const allSnapshotDates = allSnapshots.map(s => formatDate(new Date(s.snapshot_date)));
                    console.log('All snapshot dates in response:', allSnapshotDates);
                    console.log('Period check - Latest snapshot:', latestDateStr, 'Today:', todayStr, 'Current period end:', currentEndStr, 'Is today snapshot:', isTodaySnapshot, 'Has today snapshot:', hasTodaySnapshot);
                    
                    // Always adjust period to include today if:
                    // 1. Current period doesn't include today, OR
                    // 2. Latest snapshot is for today, OR
                    // 3. Latest snapshot date is after the current period end
                    if (currentEndStr < todayStr || isTodaySnapshot || latestDateStr > currentEndStr) {
                        console.log('Adjusting period to include today/latest snapshot');
                        adjustPeriodToSnapshots();
                    }
                } else {
                    // Even if no snapshots yet, ensure period includes today for future submissions
                    const currentEndStr = formatDate(getPeriodEnd());
                    if (currentEndStr < todayStr) {
                        console.log('Adjusting period to include today (no snapshots yet)');
                        adjustPeriodToSnapshots();
                    }
                }
                
                // Get snapshots for current period
                const periodSnapshots = getCurrentPeriodSnapshots();
                
                if (periodSnapshots.length === 0) {
                    loadingState.classList.add('hidden');
                    tableContent.innerHTML = '<div class="text-center py-12 text-slate-600">No inventory history found.</div>';
                    tableContent.classList.remove('hidden');
                    return;
                }
                
                // Build grid data
                gridData = buildInventoryGrid(periodSnapshots);
                
                // Render grid
                renderInventoryGrid(gridData);
                
                loadingState.classList.add('hidden');
                tableContent.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading inventory history:', error);
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
                errorMessage.textContent = error.message || 'Failed to load inventory history data';
            }
        }
        
        
        // Build inventory grid from snapshots
        function buildInventoryGrid(snapshots) {
            // Collect all unique items (SKU + Name combinations)
            const itemMap = new Map();
            
            snapshots.forEach(snapshot => {
                const items = snapshot.items || [];
                items.forEach(item => {
                    const key = `${item.sku || ''}|${item.name || ''}`;
                    if (!itemMap.has(key)) {
                        itemMap.set(key, {
                            sku: item.sku || '',
                            name: item.name || item.item_name || 'Unknown',
                            device_type: item.device_type || 'metro',
                            quantities: {}
                        });
                    }
                });
            });
            
            // Fill quantities for each date
            snapshots.forEach(snapshot => {
                const dateStr = normalizeDate(snapshot.snapshot_date);
                const items = snapshot.items || [];
                
                items.forEach(item => {
                    const key = `${item.sku || ''}|${item.name || ''}`;
                    if (itemMap.has(key)) {
                        itemMap.get(key).quantities[dateStr] = item.quantity || 0;
                    }
                });
            });
            
            // Convert to array and sort by name
            const items = Array.from(itemMap.values()).sort((a, b) => {
                return (a.name || '').localeCompare(b.name || '');
            });
            
            return {
                items: items,
                dates: snapshots.map(s => normalizeDate(s.snapshot_date))
            };
        }
        
        // Render inventory grid organized by device type
        function renderInventoryGrid(data) {
            const container = document.getElementById('tableContent');
            
            if (!data || !data.items || data.items.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-slate-600">No inventory items found for this period.</div>';
                return;
            }
            
            // Group items by device type
            const itemsByType = {
                'metro': [],
                'discontinued': [],
                'unlocked': []
            };
            
            data.items.forEach(item => {
                const deviceType = item.device_type || 'metro';
                if (itemsByType[deviceType]) {
                    itemsByType[deviceType].push(item);
                } else {
                    itemsByType['metro'].push(item);
                }
            });
            
            // Format dates for display (DD-MMM format)
            const dateHeaders = data.dates.map(dateStr => {
                const date = new Date(dateStr + 'T00:00:00');
                const day = String(date.getDate()).padStart(2, '0');
                const month = date.toLocaleDateString('en-US', { month: 'short' });
                return `${day}-${month}`;
            });
            
            let html = '';
            
            // Device type names and headers
            const deviceTypeConfig = [
                { key: 'metro', name: 'Metro Devices', class: '' },
                { key: 'discontinued', name: 'DISCONTINUED / EOL DEVICES', class: 'discontinued' },
                { key: 'unlocked', name: 'Unlocked phones/NONUP', class: '' }
            ];
            
            deviceTypeConfig.forEach(config => {
                const items = itemsByType[config.key];
                if (items.length === 0) return;
                
                // Calculate totals for this device type
                const phonesTotal = {};
                const simcardsTotal = {};
                
                data.dates.forEach(dateStr => {
                    let phonesSum = 0;
                    let simcardsSum = 0;
                    
                    items.forEach(item => {
                        const qty = item.quantities[dateStr] || 0;
                        const nameLower = (item.name || '').toLowerCase();
                        if (nameLower.includes('sim') || nameLower.includes('simcard')) {
                            simcardsSum += qty;
                        } else {
                            phonesSum += qty;
                        }
                    });
                    
                    phonesTotal[dateStr] = phonesSum;
                    simcardsTotal[dateStr] = simcardsSum;
                });
                
                html += `
                    <div class="device-type-section">
                        <div class="device-type-header ${config.class}">${config.name}</div>
                        <div class="inventory-grid-container">
                            <table class="inventory-grid-table">
                                <thead>
                                    <tr>
                                        <th class="item-header">Item Name</th>
                                        ${dateHeaders.map(header => `<th>${escapeHtml(header)}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                // Item rows
                items.forEach(item => {
                    html += '<tr>';
                    html += `<td class="item-cell">${escapeHtml(item.name || 'Unknown')}</td>`;
                    
                    data.dates.forEach(dateStr => {
                        const qty = item.quantities[dateStr];
                        if (qty !== undefined) {
                            html += `<td>${qty}</td>`;
                        } else {
                            html += `<td class="empty-cell">-</td>`;
                        }
                    });
                    
                    html += '</tr>';
                });
                
                // Add phones row
                html += '<tr class="special-row">';
                html += `<td class="item-cell">phones</td>`;
                data.dates.forEach(dateStr => {
                    const qty = phonesTotal[dateStr] || 0;
                    html += `<td>${qty}</td>`;
                });
                html += '</tr>';
                
                // Add simcards row
                html += '<tr class="special-row">';
                html += `<td class="item-cell">simcard</td>`;
                data.dates.forEach(dateStr => {
                    const qty = simcardsTotal[dateStr] || 0;
                    html += `<td>${qty}</td>`;
                });
                html += '</tr>';
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Download Excel
        async function downloadInventoryExcel() {
            console.log('Download Excel clicked, gridData:', gridData);
            
            if (!gridData || !gridData.items || gridData.items.length === 0) {
                showWarning('No inventory data available to download.');
                return;
            }
            
            try {
                console.log('Starting Excel download, items count:', gridData.items.length);
                
                // Format dates for Excel (DD-MMM format)
                const dateHeaders = gridData.dates.map(dateStr => {
                    const date = new Date(dateStr + 'T00:00:00');
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = date.toLocaleDateString('en-US', { month: 'short' });
                    return `${day}-${month}`;
                });
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Device type names for display
                const deviceTypeNames = {
                    'metro': 'Metro Devices',
                    'discontinued': 'Discontinued Phones/EOL Phones',
                    'unlocked': 'Unlocked phones/NONUP'
                };
                
                // Create a single sheet with all items combined
                const excelData = [];
                
                // Header row: Item Name + dates
                const headerRow = ['Item Name', ...dateHeaders];
                excelData.push(headerRow);
                
                // Group items by device type for organization, but combine into one sheet
                const itemsByType = {
                    'metro': [],
                    'discontinued': [],
                    'unlocked': []
                };
                
                gridData.items.forEach(item => {
                    const deviceType = item.device_type || 'metro';
                    if (itemsByType[deviceType]) {
                        itemsByType[deviceType].push(item);
                    } else {
                        itemsByType['metro'].push(item);
                    }
                });
                
                // Add all items from all categories to the single sheet with category headings
                // Order: metro, discontinued, unlocked
                const categoryOrder = ['metro', 'discontinued', 'unlocked'];
                categoryOrder.forEach(deviceType => {
                    const items = itemsByType[deviceType];
                    if (items.length === 0) return;
                    
                    // Add category heading row
                    const categoryName = deviceTypeNames[deviceType] || deviceType;
                    const headingRow = [categoryName]; // Category name in first column
                    // Fill remaining columns with empty strings
                    for (let i = 0; i < dateHeaders.length; i++) {
                        headingRow.push('');
                    }
                    excelData.push(headingRow);
                    
                    // Add all items from this category
                    items.forEach(item => {
                        const row = [item.name || 'Unknown'];
                        gridData.dates.forEach(dateStr => {
                            const qty = item.quantities[dateStr];
                            row.push(qty !== undefined ? qty : '');
                        });
                        excelData.push(row);
                    });
                });
                
                // Calculate totals for phones and simcards across ALL categories
                const phonesTotal = {};
                const simcardsTotal = {};
                
                gridData.dates.forEach(dateStr => {
                    let phonesSum = 0;
                    let simcardsSum = 0;
                    
                    // Sum across all items from all categories
                    gridData.items.forEach(item => {
                        const qty = item.quantities[dateStr] || 0;
                        const nameLower = (item.name || '').toLowerCase();
                        const skuLower = (item.sku || '').toLowerCase();
                        // Check both name and SKU for simcards
                        if (nameLower.includes('sim') || nameLower.includes('simcard') || 
                            skuLower.includes('sim') || skuLower.includes('simcard')) {
                            simcardsSum += qty;
                        } else {
                            phonesSum += qty;
                        }
                    });
                    
                    phonesTotal[dateStr] = phonesSum;
                    simcardsTotal[dateStr] = simcardsSum;
                });
                
                // Add phones summary row
                const phonesRow = ['phones', ...gridData.dates.map(dateStr => phonesTotal[dateStr] || 0)];
                excelData.push(phonesRow);
                
                // Add simcards summary row
                const simcardsRow = ['simcard', ...gridData.dates.map(dateStr => simcardsTotal[dateStr] || 0)];
                excelData.push(simcardsRow);
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                // Set column widths
                ws['!cols'] = [
                    { wch: 35 }  // Item Name column (wider to accommodate category headings)
                ];
                // Add width for each date column
                gridData.dates.forEach(() => {
                    ws['!cols'].push({ wch: 15 });
                });
                
                // Add worksheet to workbook with single sheet name
                const sheetName = 'Inventory';
                console.log('Creating single sheet:', sheetName);
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
                
                // Generate filename with date range
                const safeStoreName = storeName.replace(/[^a-zA-Z0-9_-]/g, '_');
                const startDate = formatDate(currentPeriodStart);
                const endDate = formatDate(getPeriodEnd());
                const filename = `${safeStoreName}_Inventory_${startDate}_to_${endDate}.xlsx`;
                
                // Check if workbook has any sheets
                if (wb.SheetNames.length === 0) {
                    showWarning('No data to export. Please ensure there are inventory items in the selected period.');
                    return;
                }
                
                // Download
                XLSX.writeFile(wb, filename);
                
                console.log('Excel file downloaded successfully:', filename);
                showSuccess('Inventory history downloaded successfully!');
                
            } catch (err) {
                console.error('Failed to download Excel:', err);
                console.error('Error details:', err.stack);
                showError('Failed to download Excel file: ' + (err.message || 'Unknown error'));
            }
        }
        
        // Make functions global
        window.downloadInventoryExcel = downloadInventoryExcel;
        window.loadInventoryHistory = loadInventoryHistory; // Make available globally so it can be called from other pages
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initPeriod();
            updatePeriodRange();
            loadInventoryHistory();
            
            // Event listeners
            document.getElementById('prevPeriodBtn').addEventListener('click', () => {
                currentPeriodStart.setDate(currentPeriodStart.getDate() - DAYS_PER_PERIOD);
                updatePeriodRange();
                loadInventoryHistory();
            });
            
            document.getElementById('nextPeriodBtn').addEventListener('click', () => {
                const today = new Date();
                today.setHours(23, 59, 59, 999);
                const newPeriodEnd = new Date(currentPeriodStart);
                newPeriodEnd.setDate(currentPeriodStart.getDate() + (DAYS_PER_PERIOD * 2 - 1));
                
                // Don't allow going beyond today
                if (newPeriodEnd <= today) {
                    currentPeriodStart.setDate(currentPeriodStart.getDate() + DAYS_PER_PERIOD);
                    updatePeriodRange();
                    loadInventoryHistory();
                }
            });
            
            // Download button event listener
            const downloadBtn = document.getElementById('downloadExcelBtn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Download button clicked');
                    downloadInventoryExcel();
                });
            } else {
                console.error('Download button not found!');
            }
        });
        
        // Mobile Menu Functions
        function toggleMobileMenu() {
            const overlay = document.getElementById('mobileMenuOverlay');
            const menu = document.getElementById('mobileMenu');
            overlay.classList.toggle('active');
            menu.classList.toggle('active');
            if (menu.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }
        
        function closeMobileMenu() {
            const overlay = document.getElementById('mobileMenuOverlay');
            const menu = document.getElementById('mobileMenu');
            overlay.classList.remove('active');
            menu.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMobileMenu();
            }
        });
        
        function updateMobileMenuActiveState() {
            const currentPath = window.location.pathname.split('/').pop() || 'store-inventory-history.html';
            const mobileLinks = document.querySelectorAll('.mobile-menu-link');
            mobileLinks.forEach(link => {
                link.classList.remove('active');
                const href = link.getAttribute('href');
                if (href && href !== '#') {
                    const hrefPath = href.split('/').pop().split('#')[0];
                    if (hrefPath === currentPath) {
                        link.classList.add('active');
                    }
                }
            });
        }
        
        // Handle back to super admin link
        const backToSuperAdminMobile = document.getElementById('backToSuperAdminMobile');
        // backToSuperAdmin is already declared above at line 345
        if (backToSuperAdminMobile && backToSuperAdmin) {
            backToSuperAdminMobile.href = backToSuperAdmin.href;
            backToSuperAdminMobile.onclick = function(e) {
                if (backToSuperAdmin.onclick) {
                    backToSuperAdmin.onclick(e);
                }
                closeMobileMenu();
            };
        }
        
        updateMobileMenuActiveState();
    </script>
</body>
</html>
