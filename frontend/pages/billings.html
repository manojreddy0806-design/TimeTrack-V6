<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billings — Pramaan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="static/css/style.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            DEFAULT: '#3B82F6',
                            hover: '#2563EB'
                        },
                        secondary: '#64748B',
                        light: '#F8FAFC',
                        'card-border': '#E2E8F0',
                        'input-border': '#CBD5E1'
                    }
                }
            }
        };
    </script>
    <style>
        ::-webkit-scrollbar { display: none; }
        @keyframes fadeInPage {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .page-fade-in {
            animation: fadeInPage 0.6s ease forwards;
        }
        .cash-report-table th,
        .cash-report-table td {
            border: 1px solid #E2E8F0;
        }
        .cash-report-table th {
            background-color: #F8FAFC;
        }
        .manager-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .manager-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        /* Mobile Menu Styles */
        .mobile-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .mobile-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .mobile-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 280px;
            max-width: 85vw;
            height: 100vh;
            background: linear-gradient(to bottom, #2563eb, #1d4ed8);
            z-index: 50;
            transition: right 0.3s ease;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }
        .mobile-menu.active {
            right: 0;
        }
        .mobile-menu-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .mobile-menu-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .mobile-menu-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .mobile-menu-nav {
            padding: 1rem 0;
        }
        .mobile-menu-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .mobile-menu-link:hover,
        .mobile-menu-link.active {
            background: rgba(255, 255, 255, 0.15);
            border-left-color: white;
            color: white;
        }
        .mobile-menu-link i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-light font-sans antialiased text-slate-800">
    <div id="app-container" class="min-h-screen pb-12">
        <header id="header" class="sticky top-0 z-50 w-full">
            <div class="w-[95%] max-w-7xl mx-auto mt-4 bg-gradient-to-r from-blue-600 to-blue-700 backdrop-blur-xl rounded-2xl shadow-2xl border border-blue-400/30">
                <div class="flex items-center justify-between px-10 py-4">
                    <div class="flex items-center space-x-3">
                        <div class="bg-white rounded-xl p-2.5 flex items-center justify-center hover:scale-110 transition-transform duration-200 shadow-lg">
                            <i class="fa-solid fa-clock text-blue-600 text-xl"></i>
                        </div>
                        <span class="text-2xl font-bold text-white">Pramaan</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <nav class="hidden md:flex items-center space-x-3 bg-blue-700/20 px-3 py-2 rounded-xl backdrop-blur-sm" id="main-nav">
                            <a href="#" data-nav-link data-dashboard-link class="relative z-10 flex items-center px-6 py-2.5 text-sm font-semibold text-blue-50 hover:text-white hover:bg-blue-400/50 rounded-lg transition-all duration-300 hover:scale-105 hover:shadow-lg transform">
                                <i class="fa-solid fa-chart-pie mr-2"></i>
                                Dashboard
                            </a>
                            <a href="all-managers.html" data-nav-link class="relative z-10 flex items-center px-6 py-2.5 text-sm font-semibold text-blue-50 hover:text-white hover:bg-blue-400/50 rounded-lg transition-all duration-300 hover:scale-105 hover:shadow-lg transform">
                                <i class="fa-solid fa-users mr-2"></i>
                                All Managers
                            </a>
                            <a href="#" data-subscription-link class="relative z-10 flex items-center px-6 py-2.5 text-sm font-semibold text-blue-50 hover:text-white hover:bg-blue-400/50 rounded-lg transition-all duration-300 hover:scale-105 hover:shadow-lg transform">
                                <i class="fa-solid fa-credit-card mr-2"></i>
                                Subscription
                            </a>
                        </nav>
                        <button class="hidden md:flex items-center px-6 py-2.5 text-sm font-semibold text-blue-50 hover:text-white hover:bg-blue-400/50 rounded-lg transition-all duration-300 hover:scale-105 hover:shadow-lg transform border border-white/20" onclick="logoutApp()">
                            <i class="fa-solid fa-arrow-right-from-bracket mr-2"></i>
                            Logout
                        </button>
                        <button class="md:hidden text-white hover:text-blue-200 transition-colors duration-200" onclick="toggleMobileMenu()" id="mobileMenuBtn">
                            <i class="fa-solid fa-bars text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Mobile Menu Overlay -->
        <div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="closeMobileMenu()"></div>
        
        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <div class="mobile-menu-header">
                <span class="text-white font-bold text-lg">Menu</span>
                <button class="mobile-menu-close" onclick="closeMobileMenu()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <nav class="mobile-menu-nav">
                <a href="super-admin.html" class="mobile-menu-link" onclick="closeMobileMenu()">
                    <i class="fa-solid fa-chart-pie"></i>
                    Dashboard
                </a>
                <a href="all-managers.html" class="mobile-menu-link" onclick="closeMobileMenu()">
                    <i class="fa-solid fa-users"></i>
                    All Managers
                </a>
                <a href="all-admins.html" class="mobile-menu-link" onclick="closeMobileMenu()">
                    <i class="fa-solid fa-user-shield"></i>
                    Admins
                </a>
                <a href="super-admin.html#subscription" class="mobile-menu-link" onclick="closeMobileMenu()">
                    <i class="fa-solid fa-credit-card"></i>
                    Subscription
                </a>
                <a href="cash-report.html" class="mobile-menu-link" onclick="closeMobileMenu()">
                    <i class="fa-solid fa-cash-register"></i>
                    Cash Report
                </a>
                <a href="card-report.html" class="mobile-menu-link" onclick="closeMobileMenu()">
                    <i class="fa-solid fa-credit-card"></i>
                    Card Report
                </a>
                <a href="billings.html" class="mobile-menu-link" onclick="closeMobileMenu()">
                    <i class="fa-solid fa-file-invoice-dollar"></i>
                    Billings
                </a>
                <div class="border-t border-white/20 my-2"></div>
                <button class="mobile-menu-link w-full text-left" onclick="logoutApp(); closeMobileMenu();" style="border: none; background: none; cursor: pointer;">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i>
                    Logout
                </button>
            </nav>
        </div>

        <main id="main-content" class="page-fade-in max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-12">
            <!-- Managers List View -->
            <div id="managersView" class="bg-white rounded-2xl shadow-lg border border-card-border overflow-hidden">
                <div class="px-8 py-5 border-b border-card-border flex justify-between items-center bg-slate-50/50">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Manager Billings</h2>
                        <p class="text-sm text-slate-500">View billing status by manager - <span id="currentMonthDisplay" class="font-semibold text-primary"></span></p>
                    </div>
                    <button id="backToManagersBtn" class="hidden px-4 py-2 text-sm font-semibold text-white bg-primary rounded-lg hover:bg-primary-hover transition shadow-sm" onclick="showManagersList()">
                        <i class="fa-solid fa-arrow-left mr-2"></i>
                        Back to Managers
                    </button>
                </div>
                <div id="managersList" class="p-6">
                    <div id="loadingState" class="text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mb-4"></div>
                        <p class="text-slate-600">Loading managers...</p>
                    </div>
                    <div id="errorState" class="hidden text-center py-12">
                        <i class="fa-solid fa-triangle-exclamation text-red-500 text-4xl mb-4"></i>
                        <p class="text-red-600 font-semibold" id="errorMessage">Failed to load managers</p>
                    </div>
                    <div id="managersGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Manager cards will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Manager Details View -->
            <div id="managerDetailsView" class="hidden bg-white rounded-2xl shadow-lg border border-card-border overflow-hidden mt-6">
                <div class="px-8 py-5 border-b border-card-border bg-slate-50/50 flex justify-between items-center">
                    <div>
                        <button onclick="showManagersList()" class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-primary hover:text-primary-hover transition mb-2">
                            <i class="fa-solid fa-arrow-left"></i>
                            Back to Managers List
                        </button>
                        <h2 id="managerDetailsTitle" class="text-2xl font-bold text-slate-800">Manager Billings</h2>
                    </div>
                </div>
                <div id="managerDetailsContent" class="p-6">
                    <div id="detailsLoadingState" class="text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mb-4"></div>
                        <p class="text-slate-600">Loading billing details...</p>
                    </div>
                    <div id="detailsTableContent" class="hidden overflow-x-auto">
                        <table class="w-full border-collapse cash-report-table">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-slate-900">Store</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-slate-900">Electricity Bill</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-slate-900">WiFi Bill</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-slate-900">Gas Bill</th>
                                </tr>
                            </thead>
                            <tbody id="managerBillingsBody">
                                <!-- Data rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="static/js/script.js"></script>
    <script>
        let managersData = null;
        let selectedManagerUsername = null;

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount);
        }

        async function loadManagers() {
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const managersGrid = document.getElementById('managersGrid');
            const errorMessage = document.getElementById('errorMessage');

            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            managersGrid.classList.add('hidden');

            try {
                const data = await apiGet('/billings/managers');
                managersData = data;
                renderManagersList();
                
                // Display current month
                if (data.billing_month) {
                    const monthDate = new Date(data.billing_month + '-01');
                    const monthName = monthDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    document.getElementById('currentMonthDisplay').textContent = monthName;
                }
                
                loadingState.classList.add('hidden');
                managersGrid.classList.remove('hidden');
            } catch (error) {
                console.error('Error loading managers:', error);
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
                errorMessage.textContent = error.message || 'Failed to load managers';
            }
        }

        function renderManagersList() {
            const managersGrid = document.getElementById('managersGrid');
            managersGrid.innerHTML = '';

            if (!managersData || !managersData.managers || managersData.managers.length === 0) {
                managersGrid.innerHTML = '<div class="col-span-full text-center py-8 text-slate-500">No managers found</div>';
                return;
            }

            managersData.managers.forEach(manager => {
                const card = document.createElement('div');
                card.className = 'manager-card bg-white border border-card-border rounded-xl p-6 hover:border-primary hover:shadow-md';
                card.onclick = () => showManagerDetails(manager.username);
                
                const unpaidCount = manager.unpaid_bills_count || 0;
                const paidAmount = manager.total_paid || 0;
                const allPaid = unpaidCount === 0 && manager.stores_count > 0;
                
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center">
                                <i class="fa-solid fa-user-tie text-blue-600"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-slate-900">${escapeHtml(manager.name)}</h3>
                                ${manager.location ? `<p class="text-sm text-slate-600"><i class="fa-solid fa-location-dot text-primary mr-1"></i>${escapeHtml(manager.location)}</p>` : ''}
                                <p class="text-sm text-slate-500">${manager.stores_count} store(s)</p>
                            </div>
                        </div>
                        <div class="text-right">
                            ${allPaid 
                                ? '<span class="px-2 py-1 text-xs font-semibold text-green-700 bg-green-50 rounded">All Paid</span>' 
                                : `<span class="px-2 py-1 text-xs font-semibold text-orange-700 bg-orange-50 rounded">${unpaidCount} Unpaid</span>`
                            }
                        </div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-600">Total Paid:</span>
                            <span class="font-semibold text-slate-900">${formatCurrency(paidAmount)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">Unpaid Bills:</span>
                            <span class="font-semibold text-black">${unpaidCount}</span>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-card-border">
                        <span class="text-sm text-primary font-medium">Click to view details →</span>
                    </div>
                `;
                
                managersGrid.appendChild(card);
            });
        }

        async function showManagerDetails(managerUsername) {
            selectedManagerUsername = managerUsername;
            
            const managersView = document.getElementById('managersView');
            const managerDetailsView = document.getElementById('managerDetailsView');
            const backBtn = document.getElementById('backToManagersBtn');
            const detailsLoading = document.getElementById('detailsLoadingState');
            const detailsTable = document.getElementById('detailsTableContent');
            
            managersView.classList.add('hidden');
            managerDetailsView.classList.remove('hidden');
            backBtn.classList.remove('hidden');
            detailsLoading.classList.remove('hidden');
            detailsTable.classList.add('hidden');

            try {
                const data = await apiGet(`/billings/manager/${encodeURIComponent(managerUsername)}`);
                renderManagerDetails(data);
                
                document.getElementById('managerDetailsTitle').textContent = `${data.manager.name} - Store Billings`;
                
                detailsLoading.classList.add('hidden');
                detailsTable.classList.remove('hidden');
            } catch (error) {
                console.error('Error loading manager details:', error);
                detailsLoading.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fa-solid fa-triangle-exclamation text-red-500 text-4xl mb-4"></i>
                        <p class="text-red-600 font-semibold mb-4">${error.message || 'Failed to load billing details'}</p>
                        <button onclick="showManagersList()" class="flex items-center gap-2 px-6 py-3 text-sm font-semibold text-white bg-primary rounded-lg hover:bg-primary-hover transition shadow-sm mx-auto">
                            <i class="fa-solid fa-arrow-left"></i>
                            Back to Managers List
                        </button>
                    </div>
                `;
            }
        }

        function renderManagerDetails(data) {
            const tbody = document.getElementById('managerBillingsBody');
            tbody.innerHTML = '';

            if (!data.stores || data.stores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-slate-500">No stores found for this manager</td></tr>';
                return;
            }

            data.stores.forEach(storeData => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-blue-50/30';

                // Store name cell
                const storeTd = document.createElement('td');
                storeTd.className = 'px-4 py-3 text-sm text-slate-800 font-medium';
                storeTd.textContent = storeData.name;
                tr.appendChild(storeTd);

                // Bill type cells (electricity, wifi, gas)
                ['electricity', 'wifi', 'gas'].forEach(billType => {
                    const billTd = document.createElement('td');
                    billTd.className = 'px-4 py-3 text-sm text-center';
                    
                    const billing = storeData.billing[billType] || {'paid': false, 'amount': 0};
                    
                    if (billing.paid) {
                        // Show paid status with amount
                        billTd.innerHTML = `<span class="text-slate-900 font-semibold">Paid - ${formatCurrency(billing.amount)}</span>`;
                    } else {
                        // Show unpaid status
                        billTd.innerHTML = '<span class="text-orange-600 font-semibold">Unpaid</span>';
                    }
                    
                    tr.appendChild(billTd);
                });

                tbody.appendChild(tr);
            });
        }

        function showManagersList() {
            selectedManagerUsername = null;
            
            const managersView = document.getElementById('managersView');
            const managerDetailsView = document.getElementById('managerDetailsView');
            const backBtn = document.getElementById('backToManagersBtn');
            
            // Show managers view
            managersView.classList.remove('hidden');
            // Hide details view
            managerDetailsView.classList.add('hidden');
            // Hide the back button in the header (since it's in managersView header)
            if (backBtn) {
                backBtn.classList.add('hidden');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        // Update navigation based on role
        function updateNavForRole() {
            const session = loadSession();
            if (session) {
                const dashboardLink = document.querySelector('[data-dashboard-link]');
                const subscriptionLink = document.querySelector('[data-subscription-link]');
                
                if (session.role === 'admin') {
                    if (dashboardLink) dashboardLink.href = 'admin.html';
                    if (subscriptionLink) subscriptionLink.style.display = 'none';
                } else if (session.role === 'super-admin') {
                    if (dashboardLink) dashboardLink.href = 'super-admin.html';
                    if (subscriptionLink) {
                        subscriptionLink.href = '#';
                        subscriptionLink.onclick = function() { 
                            window.location = 'super-admin.html#subscription'; 
                            return false; 
                        };
                    }
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            updateNavForRole();
            loadManagers();
        });
        
        // Mobile Menu Functions
        function toggleMobileMenu() {
            const overlay = document.getElementById('mobileMenuOverlay');
            const menu = document.getElementById('mobileMenu');
            overlay.classList.toggle('active');
            menu.classList.toggle('active');
            if (menu.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }
        
        function closeMobileMenu() {
            const overlay = document.getElementById('mobileMenuOverlay');
            const menu = document.getElementById('mobileMenu');
            overlay.classList.remove('active');
            menu.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMobileMenu();
            }
        });
        
        function updateMobileMenuActiveState() {
            const currentPath = window.location.pathname.split('/').pop() || 'billings.html';
            const mobileLinks = document.querySelectorAll('.mobile-menu-link');
            mobileLinks.forEach(link => {
                link.classList.remove('active');
                const href = link.getAttribute('href');
                if (href && href !== '#') {
                    const hrefPath = href.split('/').pop().split('#')[0];
                    if (hrefPath === currentPath) {
                        link.classList.add('active');
                    }
                }
            });
        }
        
        updateMobileMenuActiveState();
    </script>
</body>
</html>
